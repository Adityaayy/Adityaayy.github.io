<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>CSE-sec A — Data Analysis Groups</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { padding:20px; background:#f6f8fb; }
    .mono { font-family: monospace; }
    .small-note { font-size:0.85rem; color:#666; }
  </style>
</head>
<body>
<div class="container">
  <h1>CSE-sec A — Data Analysis Grouping</h1>
  <p class="small-note">Live updates — powered by Firebase</p>

  <div id="groupsArea" class="mb-3"></div>
  <h5>Unassigned Students</h5>
  <div id="unenrolledArea"></div>

  <hr>
  <h5>Join a Group</h5>
  <input id="searchName" class="form-control mb-2" placeholder="Search your name">
  <div id="searchResults"></div>

  <div id="joinPanel" style="display:none" class="mt-3">
    <input id="rollInput" class="form-control mb-2" placeholder="Enter your roll number (password)">
    <select id="groupSelect" class="form-select mb-2"></select>
    <button id="joinBtn" class="btn btn-primary">Join</button>
    <div id="joinError" class="text-danger mt-2"></div>
  </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js"></script>

<script>
// ===== Replace with your Firebase config =====
const firebaseConfig = {
  apiKey: "YOUR_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  projectId: "YOUR_PROJECT",
  storageBucket: "YOUR_PROJECT.appspot.com",
  messagingSenderId: "ID",
  appId: "APP_ID"
};
// =============================================

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let students = [];
let groups = [];
let selectedRoll = null;

// Live updates from Firestore
db.collection("students").onSnapshot(snap => {
  students = snap.docs.map(d => d.data());
  render();
});
db.collection("groups").onSnapshot(snap => {
  groups = snap.docs.map(d => d.data());
  render();
});

function render(){
  renderGroups();
  renderUnenrolled();
  populateGroupSelect();
}

function renderGroups(){
  const area = document.getElementById('groupsArea');
  if (!groups.length){ area.innerHTML = '<div class="small-note">No groups yet</div>'; return; }
  area.innerHTML = groups.map(g => {
    const members = g.members.map(r => {
      const s = students.find(s => s.roll === r);
      return `<li>${s ? s.name : r}</li>`;
    }).join('');
    return `<div class="card mb-2"><div class="card-body">
      <strong>Group ${g.id}</strong> (${g.members.length}/4)
      <ul>${members}</ul>
    </div></div>`;
  }).join('');
}

function renderUnenrolled(){
  const area = document.getElementById('unenrolledArea');
  const unen = students.filter(s => !s.groupId);
  if (!unen.length) { area.innerHTML = '<div class="small-note">All assigned</div>'; return; }
  area.innerHTML = '<ul class="list-group">' + unen.map(s => `<li class="list-group-item">${s.name}</li>`).join('') + '</ul>';
}

document.getElementById('searchName').addEventListener('input', e => {
  const q = e.target.value.toLowerCase();
  const res = students.filter(s => s.name.toLowerCase().includes(q));
  const area = document.getElementById('searchResults');
  if (!q){ area.innerHTML = ''; hideJoin(); return; }
  area.innerHTML = res.map(s => 
    `<div class="py-1 d-flex justify-content-between"><div>${s.name}</div>${
      s.groupId ? `<span class="badge bg-success">Enrolled</span>` :
      `<button class="btn btn-sm btn-outline-primary" onclick="selectStudent('${s.roll}')">I am this</button>`
    }</div>`).join('');
});

function selectStudent(roll){
  selectedRoll = roll;
  document.getElementById('joinPanel').style.display = 'block';
  document.getElementById('joinError').innerText = '';
}

function hideJoin(){
  document.getElementById('joinPanel').style.display = 'none';
  selectedRoll = null;
}

function populateGroupSelect(){
  const sel = document.getElementById('groupSelect');
  sel.innerHTML = '';
  groups.forEach(g => {
    const opt = document.createElement('option');
    opt.value = g.id;
    opt.text = `Group ${g.id} (${g.members.length}/4)`;
    sel.appendChild(opt);
  });
  const newOpt = document.createElement('option');
  newOpt.value = '__new';
  newOpt.text = `Create new group (next ${nextGroupId()})`;
  sel.appendChild(newOpt);
}
function nextGroupId(){ return groups.length ? Math.max(...groups.map(g => g.id))+1 : 1; }

document.getElementById('joinBtn').addEventListener('click', async () => {
  const entered = document.getElementById('rollInput').value.trim();
  const err = document.getElementById('joinError');
  err.innerText = '';
  if (entered !== selectedRoll){ err.innerText = 'Roll number incorrect'; return; }
  const student = students.find(s => s.roll === entered);
  if (!student) { err.innerText = 'Not found'; return; }
  if (student.groupId){ err.innerText = 'Already enrolled'; return; }

  let gid = document.getElementById('groupSelect').value;
  if (gid === '__new'){ gid = nextGroupId(); await db.collection('groups').doc(String(gid)).set({ id: gid, members: [] }); }
  gid = parseInt(gid);

  const grpRef = db.collection('groups').doc(String(gid));
  const grpSnap = await grpRef.get();
  const members = grpSnap.exists ? grpSnap.data().members : [];
  if (members.length >= 4){ err.innerText = 'Group full'; return; }

  // Update Firestore
  await db.collection('students').doc(student.roll).update({ groupId: gid });
  members.push(student.roll);
  await grpRef.set({ id: gid, members });
  hideJoin();
});

</script>
</body>
</html>
