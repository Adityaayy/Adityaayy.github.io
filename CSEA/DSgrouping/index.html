<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CSE-sec A-3rd sem | Data Analysis Case Study Grouping</title>
<style>
    body {
        font-family: sans-serif;
        background-color: #121212; /* ultra-dark */
        color: #e0e0e0;
        margin: 0;
        padding: 20px;
    }
    h1, h2, h3 {
        color: #ff8c42; /* softer orange accent */
    }
    .container {
        display: flex;
        gap: 40px;
        flex-wrap: wrap;
    }
    .section {
        flex: 1;
        min-width: 280px;
        background-color: #1e1e1e;
        padding: 15px;
        border-radius: 8px;
    }
    .student-item {
        font-size: 1.1rem;
        padding: 6px 8px;
        border-bottom: 1px solid #333;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .student-item button {
        background-color: #ff8c42;
        color: #121212;
        border: none;
        padding: 4px 8px;
        font-size: 0.9rem;
        border-radius: 4px;
        cursor: pointer;
    }
    .student-item button:hover {
        background-color: #e67c34;
    }
    .btn-orange {
        background-color: #ff8c42;
        color: #121212;
        border: none;
        padding: 8px 14px;
        font-size: 1rem;
        border-radius: 6px;
        cursor: pointer;
        margin-top: 10px;
    }
    .btn-orange:hover {
        background-color: #e67c34;
    }
    #controlsTitle {
        font-size: 1.3rem;
        color: #ccc;
        font-weight: bold;
        margin-bottom: 6px;
    }
</style>
</head>
<body>
<h1>CSE-sec A-3rd sem</h1>
<h2>Data Analysis Case Study Student Grouping</h2>

<div class="container">
    <div class="section">
        <h3>Unassigned Students</h3>
        <div id="unassignedList"></div>
    </div>
    <div class="section">
        <h3>Assigned Students</h3>
        <div id="assignedList"></div>
        <button id="leaveGroupBtn" class="btn-orange" style="display:none;">Leave this group</button>
    </div>
    <div class="section">
        <div id="controlsTitle">Dutta controls</div>
        <button id="exportBtn" class="btn-orange">Export JSON</button>
        <button id="refreshBtn" class="btn-orange">Refresh</button>
    </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
<script>
    // === Your existing Firebase config ===

    // Your web app's Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyC7872cCC6wXWgy8Drj1N0yET9nk0a7KM4",
  authDomain: "csea-dsgrouping.firebaseapp.com",
  projectId: "csea-dsgrouping",
  storageBucket: "csea-dsgrouping.firebasestorage.app",
  messagingSenderId: "367385736275",
  appId: "1:367385736275:web:907bb7e06f7efc550cc2a6"
};
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let selectedAssignedStudent = null;

    async function loadData() {
        const studentsSnap = await db.collection('students').get();
        const students = studentsSnap.docs.map(d => d.data());
        const unassigned = students.filter(s => !s.groupId);
        const assigned = students.filter(s => s.groupId);

        renderUnassigned(unassigned);
        renderAssigned(assigned);
    }

    function renderUnassigned(unassigned) {
        const list = document.getElementById('unassignedList');
        list.innerHTML = '';
        unassigned.forEach(stu => {
            const div = document.createElement('div');
            div.className = 'student-item';
            div.innerHTML = `<span>${stu.name}</span>
                <button onclick="joinPrompt('${stu.roll}')">Join</button>`;
            list.appendChild(div);
        });
    }

    function renderAssigned(assigned) {
        const list = document.getElementById('assignedList');
        list.innerHTML = '';
        assigned.forEach(stu => {
            const div = document.createElement('div');
            div.className = 'student-item';
            div.textContent = stu.name;
            div.onclick = () => {
                selectedAssignedStudent = stu;
                document.getElementById('leaveGroupBtn').style.display = 'block';
            };
            list.appendChild(div);
        });
    }

    async function joinPrompt(roll) {
        const entered = prompt("Enter your roll number to confirm:");
        if (entered !== roll) {
            alert("Incorrect roll number.");
            return;
        }
        const groupId = prompt("Enter group number to join:");
        if (!groupId) return;

        const studentRef = db.collection('students').doc(roll);
        await studentRef.update({ groupId: groupId });

        const groupRef = db.collection('groups').doc(groupId);
        await groupRef.set({
            members: firebase.firestore.FieldValue.arrayUnion(roll)
        }, { merge: true });

        alert(`Joined Group ${groupId}.`);
        loadData();
    }

    document.getElementById('leaveGroupBtn').addEventListener('click', async () => {
        if (!selectedAssignedStudent) return alert('Select your name first.');
        const rollInput = prompt("Enter your roll number to leave group:");
        if (rollInput !== selectedAssignedStudent.roll) {
            alert("Incorrect roll number.");
            return;
        }

        const groupId = selectedAssignedStudent.groupId;
        const groupRef = db.collection('groups').doc(String(groupId));
        const studentRef = db.collection('students').doc(selectedAssignedStudent.roll);

        await groupRef.update({
            members: firebase.firestore.FieldValue.arrayRemove(selectedAssignedStudent.roll)
        });
        await studentRef.update({ groupId: null });

        alert(`You have left Group ${groupId}.`);
        selectedAssignedStudent = null;
        document.getElementById('leaveGroupBtn').style.display = 'none';
        loadData();
    });

    document.getElementById('exportBtn').addEventListener('click', async () => {
        const studentsSnap = await db.collection('students').get();
        const students = studentsSnap.docs.map(d => d.data());

        const groupsMap = {};
        const unassigned = [];

        students.forEach(stu => {
            if (stu.groupId) {
                if (!groupsMap[stu.groupId]) {
                    groupsMap[stu.groupId] = [];
                }
                groupsMap[stu.groupId].push({ name: stu.name, roll: stu.roll });
            } else {
                unassigned.push({ name: stu.name, roll: stu.roll });
            }
        });

        const output = {};
        Object.keys(groupsMap).sort((a, b) => Number(a) - Number(b))
            .forEach(gid => {
                output[`Group ${gid}`] = { members: groupsMap[gid] };
            });
        output["Unassigned"] = unassigned;

        const blob = new Blob([JSON.stringify(output, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'group_data.json';
        a.click();
    });

    document.getElementById('refreshBtn').addEventListener('click', loadData);

    loadData();
</script>
</body>
</html>
